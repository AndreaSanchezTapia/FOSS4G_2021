<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>english.knit</title>
    <meta charset="utf-8" />
    <meta name="author" content="Andrea Sánchez-Tapia" />
    <meta name="date" content="2021-09-30" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="font.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">

class: middle





<div>
<style type="text/css">.xaringan-extra-logo {
width: 300px;
height: 128px;
z-index: 0;
background-image: url(figs/logo.png);
background-size: contain;
background-repeat: no-repeat;
position: absolute;
bottom:1em;left:88%;
}
</style>
<script>(function () {
  let tries = 0
  function addLogo () {
    if (typeof slideshow === 'undefined') {
      tries += 1
      if (tries < 10) {
        setTimeout(addLogo, 100)
      }
    } else {
      document.querySelectorAll('.remark-slide-content:not(.title-slide):not(.inverse):not(.hide_logo)')
        .forEach(function (slide) {
          const logo = document.createElement('div')
          logo.classList = 'xaringan-extra-logo'
          logo.href = null
          slide.appendChild(logo)
        })
    }
  }
  document.addEventListener('DOMContentLoaded', addLogo)
})()</script>
</div>

&lt;style type="text/css"&gt;
.remark-slide-number {
  display: none;
}
&lt;/style&gt;

&lt;br&gt;
&lt;br&gt;
&lt;center&gt;
# Creating open, reproducible workflows for ecological niche modeling

### Andrea Sánchez-Tapia, Sara Ribeiro Mortara, Felipe Sodré Barros

### FOSS4G 2021
&lt;/center&gt;
&lt;br&gt;

.center[
__[Diapositivas en Castellano](https://andreasancheztapia.github.io/FOSS4G_2021/espa%C3%B1ol#1)
]__



---
background-image: url("figs/logo_jbrj.png")
background-position: 98% 2%
background-size: 100px
.left-column[
&lt;img src="figs/andrea.jpg" title="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" alt="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" width="90" style="display: block; margin: auto auto auto 0;" /&gt;&lt;img src="figs/SRM.jpg" title="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" alt="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" width="90" style="display: block; margin: auto auto auto 0;" /&gt;&lt;img src="figs/Felipe_Barros.jpg" title="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" alt="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" width="90" style="display: block; margin: auto auto auto 0;" /&gt;&lt;img src="figs/gui.jpeg" title="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" alt="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" width="90" style="display: block; margin: auto auto auto 0;" /&gt;&lt;img src="figs/diogo.jpeg" title="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" alt="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" width="90" style="display: block; margin: auto auto auto 0;" /&gt;&lt;img src="figs/mari.jpeg" title="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" alt="Pictures of the team: Andrea Sánchez-Tapia, Sara Mortara, Felipe Sodré Barros, Guilherme Gall, Diogo Rocha, and Marinez Ferreira de Siqueira (PI)" width="90" style="display: block; margin: auto auto auto 0;" /&gt;
]

.right-column[
.left[ #### Scientific Computation Laboratory - Rio de Janeiro Botanical Garden]
#### ¡liibre! Independent Biodiversity Informatics Laboratory


+ Biodiversity informatics, ENM/SDM, open science, reproducibility
+ Scientific workflows based in R for data downloading and cleaning, taxonomic checking
+ Support for data-intensive research projects (e.g., CNCFlora - IUCN authority)
]


---

Reproducibility:
"data and code being available to fully rerun the analysis" -- _The Turing Way_

---

+ Version control
+ Reproducible computational environments:
many levels: package version awareness, controllers: Renv, containers: Docker

---
## why build an ENM package?

+ Usabilidad
+ Calidad
+ Estilo
+ Documentación
+ Qué gap llena?
+ En qué mejora flujos previos?

necesitábamos un flujo de trabajo

---
## why building an ENM package?

- We started with a __project-specific__ set of scripts to execute ENM for species in the Brazilian Atlantic Forest
- Other projects: similar structure but flexibility needed depending on the __research question__
- Many options within R:

  - GIS with __raster__, __sp__, __maps__, __rgdal__, __sf__
  - Established packages such as __dismo__ (Hijmans et al 2017), __BIOMOD2__ (Thuiller et al 2007)
  - Other packages: **ENMeval** (Muscarella et al 2014), **sdm** (Naimi &amp; Araujo 2016), **spThin** (Aiello-Lammens et al 2015), **zoon** (Golding et al. 2018), **wallace** (Kass et al 2018), **kuenm** (Cobos et al 2019), **occCite** (Lowens 2020)

__We needed a workflow rather than independent R packages__

---
## folder structure and portability

.pull-left[
+ A single working directory per project
+ Different steps: different subfolders
+ A consistent subfolder structure
+ Relative rather than absolute paths and no `setwd()`
]

.pull-right[
&lt;img src="figs/fig03_folder.png" width="772" /&gt;
]

---
## modularity

+ Each step saves its output
+ The next step reads the previous output
+ Using HD space rather than RAM
+ The user may enter and exit the workflow at any step
+ Parallelization and use in high performance/high throughput computational frameworks (HPC/HTC)

---
## reproducibility

&lt;img src="figs/feng.png" width="600" /&gt;

---
## thorough metadata recording

+ parametrization options
+ session information
+ packages used and their version

---
## interoperability

We did not create new classes or methods: communication with other packages in the R environment

&lt;img src="figs/xkcd_standards.png" title="xkcd comic: title: how standards proliferate: (see a/c chargers, chracater encodings, instant messaging, etc) First frame: Situation: There are 14 competing standards. Second frame: two human figures. Person 1: '14?! Ridiculous! We need to develop one universal standard that covers everyone's use cases'. Person 2: 'Yeah!'. Third frame: Soon: Situation: There are 15 competing standards." alt="xkcd comic: title: how standards proliferate: (see a/c chargers, chracater encodings, instant messaging, etc) First frame: Situation: There are 14 competing standards. Second frame: two human figures. Person 1: '14?! Ridiculous! We need to develop one universal standard that covers everyone's use cases'. Person 2: 'Yeah!'. Third frame: Soon: Situation: There are 15 competing standards." width="719" /&gt;

---
## modleR

A workflow developed to automatize some of the common steps in ecological niche modeling

&lt;img src="figs/modleR.png" width="150" /&gt;

---
## a four-step workflow

+ `setup_sdmdata()`: data setup, cleaning, partition, pseudoabsence selection
+ `do_any()` and `do_many()`: model fitting, projecting and evaluating
+ `final_model()`: joining partitions
+ `ensemble_model()`: algorithm consensus

---
## a four-step workflow

.center[
&lt;img src="figs/WORKFLOW.png" title="Workflow scheme. The first step cleans and partitions data into training and test sets, samples pseudoabsences and controls for the correlation of explanatory variables. The second step fits an algorithm per partition, for each train and test set. The third step joins partitions, creating a model per algorithm. The fourth step analyzes algorithm consensus -'ensemble modeling', to obtain a unique model per species" alt="Workflow scheme. The first step cleans and partitions data into training and test sets, samples pseudoabsences and controls for the correlation of explanatory variables. The second step fits an algorithm per partition, for each train and test set. The third step joins partitions, creating a model per algorithm. The fourth step analyzes algorithm consensus -'ensemble modeling', to obtain a unique model per species" width="1000" /&gt;
]

---
## Step 1 `setup_sdmdata()`: data preparation

Data preparation and cleaning should be performed previously

+ Optional data cleaning checks: exact duplicates, NAs and one occurrence per pixel
+ Experimental design: bootstrap, cross-validation
+ Pseudo-absence sampling
+ Control of variable correlation up to a user-defined value (e.g., 0.8)

---
## pseudoabsence sampling

&lt;img src="figs/fig04_buffer.png" width="800" style="display: block; margin: auto;" /&gt;

---
## pseudoabsence sampling

&lt;img src="figs/buffer/1_no_buffer.png" width="200" /&gt;&lt;img src="figs/buffer/meandist_and_mindist.png" width="200" /&gt;&lt;img src="figs/buffer/usr_shape_and_mindist.png" width="200" /&gt;

+ no buffer
+ mean distance buffer and euclidean distance filter
+ user-defined buffer (M) and euclidean distance filter


---
## `setup_sdmdata()` output

At the end of data setup:

+ metadata and session information
+ a data frame `sdmdata.csv` that will be used in the next step

&lt;img src="figs/sdmdata_table.png" width="600" /&gt;&lt;img src="figs/metadata.png" width="600" /&gt;

---
## Step 2. `do_(m)any()`: model fitting and projection

+ `do_any()` for one algorithm and partition (ex. `algo = "maxent"`)
+ `do_many()` calls `do_any()` to fit multiple algorithms (ex: `bioclim = TRUE`, `maxent = TRUE`)
+ Parametrization
+ The user can apply a mask
+ Projection to different datasets (in time or space)
+ Returns table with performance statistics -&gt; TSS, AUC, pROC, FNR, Jaccard...

---
## `do_(m)any()`: model fitting and projection

Current algorithms:

+ bioclim, mahalanobis distance, maxent from dismo package
+ Boosted regression trees (BRT) as implemented by `gbm.step()` function in __dismo__ package
+ maxent from __maxnet__ package
+ GLM from base R, implemented with a stepwise selection approach
+ Support Vector Machines (SVM), from packages __kernlab__ and __e1071__
+ Random Forests from package __randomForest__

---
## `do_(m)any()` output

At the end of the model fitting stage:

+ Outputs in the hard disk: .tif, .png for each partition
+ Evaluation data frames with the performance statistics at different thresholds
+ Metadata and session information

---
## `do_(m)any()` output (one fit model per partition)

&lt;img src="figs/modleR/rf_cont_Abarema_langsdorffii_1_1.png" width="300" /&gt;&lt;img src="figs/modleR/rf_cont_Abarema_langsdorffii_1_2.png" width="300" /&gt;&lt;img src="figs/modleR/rf_cont_Abarema_langsdorffii_1_3.png" width="300" /&gt;

_Abarema langsdorffii_, three partitions, randomForests

---
## Step 3. `final_model()`: a model per algorithm per species

+ The basics: a central tendency measure and uncertainty between partitions
+ Which models to join? (the raw continuous model, the binary)
+ Some additional operations: consensus between binary models
      %\subitem - buscar um limiar médio e recuperar o binário e o contínuo a partir dele \\
      %\subitem - extrair o consenso entre os binários \\
+ Uncertainty: range (max - min) between partitions

---
## `final_model()`: a model per algorithm per species

.center[
&lt;img src="figs/fig05_finalmodel.png" width="400" /&gt;
]

---
## `final_model()`: a model per algorithm per species

&lt;img src="figs/modleR/Abarema_langsdorffii_rf_raw_mean.png" width="300" /&gt;&lt;img src="figs/modleR/Abarema_langsdorffii_rf_bin_consensus.png" width="300" /&gt;&lt;img src="figs/modleR/Abarema_langsdorffii_rf_raw_uncertainty.png" width="300" /&gt;

Raw mean
Binary consensus
Uncertainty (range)

---
## Step 4. `ensemble_model()` - algorithmic consensus

+ Mean between final models
+ Consensus
+ Best-performing algorithm
+ PCA between algorithms
+ Range uncertainty metrics
+ Ensemble models do not necessarily perform better than individual algorithms (Zhu &amp; Peterson 2017)
+ Evaluate different ensemble model performance (WIP)

---
## final remarks

+ Reproducibility should drive any ENM workflow
+ Metadata are really useful - and necessary
+ Any ENM workflow should be easily adapted to HPC
+ Flexibility to start and leave at any step is essential to guarantee a solid evaluation of ENMs
+ It is not a problem to have one more package if it integrates with other packages
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": "none",
"seal": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
